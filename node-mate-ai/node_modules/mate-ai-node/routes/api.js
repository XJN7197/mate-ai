const express = require('express');
const axios = require('axios');
const UserData = require('../models/UserData');
const router = express.Router();

// 处理聊天消息
router.post('/chat', async (req, res) => {
  const { userId, message } = req.body;

  try {
    // 调用 AI API 获取回复
    console.log('Sending request to AI API:', {
      url: process.env.AI_API_URL,
      message: message,
      headers: {
        'Authorization': `Bearer ${process.env.AI_API_KEY}`,
        'Content-Type': 'application/json'
      }
    });
    
    const aiResponse = await axios.post(
      `${process.env.AI_API_URL}/v1/chat/completions`,
      {
        model: "deepseek-ai/DeepSeek-V3",
        messages: [{ role: "user", content: message }]
      },
      { 
        headers: { 
          'Authorization': `Bearer ${process.env.AI_API_KEY}`,
          'Content-Type': 'application/json'
        },
        timeout: 30000, // 设置30秒超时
        validateStatus: function (status) {
          return status >= 200 && status < 500; // 只有状态码大于等于500时才会reject
        }
      }
    );

    console.log('AI API Response:', aiResponse